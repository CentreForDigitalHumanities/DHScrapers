apiVersion: batch/v1
kind: Job
metadata:
  name: dh-scrapers-job
spec:
  template:
    spec:
      volumes:
      - name: dh-scrapers-vol
        persistentVolumeClaim:
          claimName: dh-scrapers-pvc
      - name: dh-scrapers-secret
        secret:
          secretName: elasticsearch-apikey
      initContainers:
      - name: timestamped-directory
        image: busybox
        volumeMounts:
        - name: dh-scrapers-vol
          mountPath: /current_run # on Pod
          subPath: current_run # inside PVC
        command: ['sh', '-c', 'DIR_STAMP=$(date +%Y%m%d_%H%M%S); echo "$DIR_STAMP" > /current_run/is-scraping; cat /current_run/is-scraping']
      - name: dh-scrapers-iis
        image: ghcr.io/centrefordigitalhumanities/dh-scrapers-openshift:latest
        volumeMounts:
        - name: dh-scrapers-vol
          mountPath: /harvest-metadata # on Pod
          subPath: current_run/harvest-metadata # inside PVC
        - name: dh-scrapers-vol
          mountPath: /iis-files # on Pod
          subPath: current_run/iis-files # inside PVC
        command: ['sh', '-c','/scripts/export-newest.sh']
      - name: echoes-from-the-sea
        image: busybox
        envFrom:
        - configMapRef:
            name: dh-scrapers-cm
        volumeMounts:
        - name: dh-scrapers-secret
          mountPath: "/secrets"
          readOnly: true
        command: ['sh', '-c', 'cat /secrets/elastic-apikey; echo $FAV_FRUIT;']
      - name: fill-move-delete
        image: busybox
        volumeMounts:
        - name: dh-scrapers-vol
          mountPath: /current_run
          subPath: current_run
        - name: dh-scrapers-vol
          mountPath: /previous_runs
          subPath: previous_runs
        command: ['sh', '-c', 'DIR_STAMP=$(cat /current_run/is-scraping); echo "apple" >> /current_run/basket.txt; echo "peach" >> /current_run/basket.txt; cat /current_run/basket.txt; mv /current_run/ /previous_runs/$DIR_STAMP; rm /previous_runs/$DIR_STAMP/is-scraping']
      - name: number-crunch2timeline
        image: busybox
        volumeMounts:
        - name: dh-scrapers-vol
          mountPath: /crunch-data
        # command: ['sh', '-c', 'exit 1'] # kill -SIGHUP $$
        command: ['sh', '-c', 'for i in 1 2 3 4 5 6 7 8 9 10; do echo "chomp `date`" >> /crunch-data/timeline.txt && sleep 3s; done;'] # 10*17280s=172800s=2days
      containers:
      - name: initcons-done
        image: busybox
        command: ['sh', '-c', 'echo "Init containers completed" && cat /scrapers_data/timeline.txt; rm /scrapers_data/timeline.txt; ls /scrapers_data/previous_runs']
        volumeMounts:
        - name: dh-scrapers-vol
          mountPath: /scrapers_data
      restartPolicy: Never
  backoffLimit: 0
